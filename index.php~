<?php

CONST TABLE = 'ProjectTimeTrack';
CONST HOURSaDAY = 8;

$DatabaseDefinition = <<<'EOS'
(
`Project` VARCHAR( 100 ) NOT NULL ,
`Collegue` VARCHAR( 100 ) NOT NULL ,
`Minutes` TINYINT UNSIGNED NOT NULL ,
`Stamp` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE = MYISAM;
EOS;
$mysql = new mysqli("localhost", "ProjectTimeTrack", "WWc2qYGKxjuqHbUF", "ProjectTimeTrack");
if ($mysql->connect_errno) {
    printf("Connect failed: %s\n", $mysql->connect_error);
    exit();
}
$mysql->query("CREATE TABLE IF NOT EXISTS `" . TABLE . "` " . $DatabaseDefinition);
if ($mysql->errno) {die("MySQL query failed");}

function MinutesToTime($minutes) {
  $hours = floor($minutes/60);
  $minutes -= $hours*60;
  $days = floor($hours/HOURSaDAY);
  $hours -= $days*HOURSaDAY;
  if ($days>0) {
    return sprintf("%dd %d:%02d", $days, $hours, $minutes);
  } else {
    return sprintf("%d:%02d", $hours, $minutes);
  }
}

function show($mysql, $categorie) {
  if (!is_null($categorie)) {
    $WHERE = " WHERE `Project` like '" . $categorie . "%'";
  } else {
    $WHER = "";
  }
  $table = TABLE;
  // Fetch collegues
  $result = $mysql->query("SELECT DISTINCT `Collegue` FROM `$table`" . $WHERE);
  if ($mysql->errno) {die("MySQL collegue query failed");}
  $n = $result->num_rows;
  for ($i=0; $i<$n; $i++) {
    $c = $result->fetch_row();
    $Collegue[] = $c[0];
  }
  
  // Fetch projects
  $result = $mysql->query("SELECT DISTINCT `Project` FROM `$table`" . $WHERE);
  if ($mysql->errno) {die("MySQL project query failed");}
  $n = $result->num_rows;
  for ($i=0; $i<$n; $i++) {
    $p = $result->fetch_row();
    $Project[] = $p[0];
  }
  
  // Fetch times
  $result = $mysql->query("SELECT `Project`, `Collegue`, SUM(`Minutes`) as 'Minutes' FROM `$table`" . $WHERE . " GROUP BY `Project`, `Collegue` WITH ROLLUP");
  if ($mysql->errno) {die("MySQL time query failed");}
  $n = $result->num_rows;
  for ($i=0; $i<$n; $i++) {
    $row = $result->fetch_assoc();
    if (is_null($row['Collegue']) && !is_null($row['Project'])) {
      continue;
    }
    $Minutes[$row['Project']][$row['Collegue']] = $row['Minutes'];
  }

  require_once("template.table.php");
}

function edit($mysql, $collegue, $project, $minutes) {
  $mysql->query("INSERT `ProjectTimeTrack` SET `Project` = '$project', `Collegue` = '$collegue', `Minutes` = '$minutes'");
  if ($mysql->errno) {die("MySQL insert failed");}
}

if (key_exists("collegue", $_POST) && key_exists("project", $_POST) && key_exists("minutes", $_POST)) {
  $time = explode(":", $_POST["minutes"]);
  edit($mysql, $_POST["collegue"], $_POST["project"], $time[0]*60+$time[1]);
  exit();
} else if (key_exists("table", $_POST)) {
  show($mysql, $_POST["table"]);
  exit();
}
require_once("template.html.php");
